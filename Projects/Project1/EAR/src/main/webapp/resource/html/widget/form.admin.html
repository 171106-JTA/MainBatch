<!--  ACCOUNT INFORMATION FOR EMPLOYEES  -->
<body>
	<script type="text/javascript">
			///
			//	INITIALIZERS
			///
			
			var initHTML = function () {
				var screen = $("div[is-screen]");
				var picker = screen.find("div[class='input-group date']");
				
				// Build info icons
				Util.buildInfoIcons($("div[is-drawer]"));
				Util.buildInfoIcons($("#frmPageForm"));
				
				// init datepickers
				picker.datetimepicker();
				
				loadFilterData();
			}
			
			var initEventHandlers = function () {
				// assign pill events 
				$("#frmPills").find("li").on("click", onPillClick);
				
				// When Admin wants to create account 
				$("#frmCreateFormStatusUpdate").on("click", onCreateFormStatus);
				$("#frmSubmitStatusUpdate").on("click", onSendStatusUpdateRequest);
				
				// modals
				$("#frmGradeAttachments").on("click", onOpenGradeModal);
				$("#frmOtherAttachments").on("click", onOpenOtherModal);
				
				// buttons
				$("#frmSearchForm").on("click", onSearchFormClick);
			}
			
			var initUpdateStatusModule = function () {
				var template = $("div[update-form-module-template]");
				var module = template.children().clone(true);
				
				// update status select
				module.find("#frmProcessedBy").val(data.user.username);
				module.find("#frmStatus").append($("#frmStatusData").children().clone(true));
				module.find("#frmStatusTimeStamp").val(moment(new Date()).format("DD/MM/YYYY"));
				module.find("#frmOriginalEstimate").val(calculateEstimate());
				return module;
			}
			
			///
			//	HELPERS
			///
			
			var loadFilterData = function () {
				// Build select filter 
				Util.buildCodeList({
					"code" : "STATUS",
					"node" : $("#frmStatusData"),
					"display" : "value description"
				});
				
				Util.buildCodeList({
					"code" : "STATUS",
					"node" : $("#frmApplicationStatus"),
					"display" : "value description"
				});
				
				Util.buildCodeList({
					"code" : "GRADING-TYPE",
					"node" : $("#frmGradeScale"),
					"display" : "value description"
				});
				
				Util.buildCodeList({
					"code" : "REIMBURSEMENT-RATE",
					"node" : $("#frmReimbursementType"),
					"display" : "value"
				});
				
				Util.buildCodeList({
					"code" : "US-STATE",
					"node" : $("#frmApplicationState"),
					"display" : "value"
				});
				
				Util.buildCodeList({
					"code" : "CITY-CODE",
					"node" : $("#frmApplicationCity"),
					"display" : "description"
				});
			}
			
			var extractStatusData = function (node) {
				var data;
				
				data = {
					"processedBy": node.find("#frmProcessedBy").val(),
					"status": node.find("#frmStatus").val(),
					"timestamp": node.find("#frmStatusTimeStamp").val(),
					"reimbursement": node.find("#frmActualPrice").val(),
					"description": node.find("#frmStatusDescription").val()
				}
				
				return data;
			}
			
			var disableStatusBlock = function (node) {
				node.removeClass("new-status");
				node.find("input").prop("disabled", true);
				node.find("select").prop("disabled", true);
				node.find("textarea").prop("disabled", true);
			}
			
			var clearForm = function () {
				var screen = $("div[is-screen]");
				
				// remove all data
				screen.find("input").val("");
				screen.find("select").val("");
				screen.find("textarea").val("");
				screen.find("#formIdHeader").text("");
				$("#frmGradeFileList").empty();
				$("#frmOtherFileList").empty();
			}
			
			var setFormData = function (params) {
				var screen = $("div[is-screen]");
					
				// Set Form data
				screen.find("#formIdHeader").text(params.formId ? "#" + params.formId : "");
				screen.find("#frmUserId").val(params.userId);
				screen.find("#frmFirstName").val(params.firstName);					
				screen.find("#frmLastName").val(params.lastName);					
				screen.find("#frmPhoneNumber").val(params.phoneNumber);					
				screen.find("#frmEmail").val(params.email);					
				screen.find("#frmApplicationDepartment").val(params.department);					
				screen.find("#frmApplicationStatus").val(params.status || "NEW");						
				screen.find("#frmReimbursementType").val(params.reimbursementRate || "");					
				screen.find("#frmApplicationAddress").val(params.address || "");					
				screen.find("#frmApplicationState").val(params.state || "");					
				screen.find("#frmApplicationCity").val(params.city || "");					
				screen.find("#frmEventStartDTPInput").val(params.eventDateTimeStart);					
				screen.find("#frmEventEndDTPInput").val(params.eventDateTimeEnd);					
				screen.find("#frmWorkOffStartDTPInput").val(params.timeOffBegin);					
				screen.find("#frmWorkOffEndDTPInput").val(params.timeOffEnd);					
				screen.find("#frmGradeScale").val(params.gradingType || "");					
				screen.find("#frmApplicationCost").val(params.eventCost || 0);					
				screen.find("#frmDescription").val(params.description || "");											
				screen.find("#frmApplicationEstimate").val(calculateEstimate());											

				assignGradeAttachments(params);
				assignOtherAttachments(params);
			}
			
			var assignGradeAttachments = function (params) {
				var list = $("#frmGradeFileList");
				
				$.each(params.gradeAttachments, function (i, attachment) {
					list.append(createAttachment({ "fileName": attachment, "id": params.gradeAttachmentIds[i] }));
				});
			}
			
			var assignOtherAttachments = function (params) {
				var list = $("#frmOtherFileList");
				
				$.each(params.otherAttachments, function (i, attachment) {
					list.append(createAttachment({ "fileName": attachment, "id": params.otherAttachmentIds[i] }));
				});
			}
			
			var createAttachment = function (params) {
				var li = $("<li></li>");
				
				li.html(params.fileName);
				li.attr("id", params.id);
				li.on("click", onDownloadFile);
				
				return li;
			}
			
			var getFormData = function () {
				var screen = $("div[is-screen]");
				var data;
				
				data = {
					"userId": screen.find("#frmUserId").val(),
					"firstName": screen.find("#frmFirstName").val(),					
					"lastName": screen.find("#frmLastName").val(),				
					"phoneNumber": screen.find("#frmPhoneNumber").val(),					
					"email": screen.find("#frmEmail").val(),
					"department": screen.find("#frmApplicationDepartment").val(),					
					"status": screen.find("#frmApplicationStatus").val(),						
					"reimbursementType": screen.find("#frmReimbursementType").val(),				
					"address": screen.find("#frmApplicationAddress").val(),					
					"state": screen.find("#frmApplicationState").val(),	
					"city": screen.find("#frmApplicationCity").val(),				
					"eventDateTimeStart": screen.find("#frmEventStartDTPInput").val(),					
					"eventDateTimeEnd": screen.find("#frmEventEndDTPInput").val(),					
					"timeOffBegin": screen.find("#frmWorkOffStartDTPInput").val(),					
					"timeOffEnd": screen.find("#frmWorkOffEndDTPInput").val(),					
					"gradingType": screen.find("#frmGradeScale").val(),				
					"eventCost": screen.find("#frmApplicationCost").val(),					
					"description": screen.find("#frmDescription").val()
				};
				
				return data;
			}
			
			var getAlwaysDisabledFields = function () {
				var fields;
				
				fields = [
					"frmUserId",
					"frmEmail",
					"frmFirstName",
					"frmLastName",
					"frmApplicationEstimate",
					"frmPhoneNumber",
					"frmEstimate",
					"frmApplicationDepartment",
					"frmApplicationStatus"
				];
				
				return fields;
			}
			
			var calculateEstimate = function () {
				var screen = $("div[is-screen]");
				var select = screen.find("#frmReimbursementType");
				var option = $(select.children().toArray()[select.prop("selectedIndex")]);
				var eventCost = screen.find("#frmApplicationCost");
				var cost = 0.0;
			
				if (option.attr("desc") && eventCost.val())
					cost = parseFloat(option.attr("desc")) * eventCost.val();
				
				return cost;
			}
			
			var buildStatusList = function (statusList) {
				var ul = $("#frmStatusList");
				statusList = statusList || [];
				
				$.each(statusList, function (i, status){
					ul.append(buildStatus(status));
				});
			}
			
			var buildStatus = function (status) {
				var template = $("div[update-form-module-template]");
				var module = template.children().clone(true);

				// update status select
				module.find("#frmProcessedBy").val(status.processedBy);
				module.find("#frmStatus").append($("#frmStatusData").children().clone(true));
				module.find("#frmStatus").val(status.status);
				module.find("#frmStatusTimeStamp").val(status.timestamp);
				module.find("#frmActualPrice").val(status.reimbursement);
				module.find("#frmStatusDescription").val(status.description);
				module.find("#frmOriginalEstimate").val(calculateEstimate());
				disableStatusBlock(module);
				return module;
			}
			
			///
			//	EVENT HANDLERS
			///
			
			var onPillClick = function () {
				var active = $("#frmPills").find("li[class~='active']");
				var self = $(this);
				
				// remove active status 
				active.removeClass("active");
				
				// hide old active content
			    $("#" + active.attr("page")).hide();
				
				// set current to active
				self.addClass("active");
				
				// show new content
				 $("#" + self.attr("page")).fadeIn("normal");
			}
			
			/**
			 *	When admin wants to update form
			 */
			var onCreateFormStatus = function () {
				var self = $(this);
				var screen = $("div[is-screen]");
				var drawer = $("div[is-drawer]");
				var update = drawer.find("#frmSubmitStatusUpdate");
				var ul = screen.find("#frmStatusList");
				var module = initUpdateStatusModule();
				
				// disable until status update submitted
				self.prop("disabled", true);
				
				// Enable button to send update request
				update.prop("disabled", false);
				
				// Inject new templated module
				ul.prepend(module);
				Util.buildInfoIcons(module);
				// Invoke pill click to page
				screen.find("li[page='frmPageStatus']").click();
			}
			
			/**
			 * Invoked when admin wants to submit status update 
			 */
			var onSendStatusUpdateRequest = function () {
				var self = $(this);
				var screen = $("div[is-screen]");
				var drawer = $("div[is-drawer]");
				var create = drawer.find("#frmCreateFormStatusUpdate");
				var ul = screen.find("#frmStatusList");
				var div = ul.find("div[class~='new-status']");
				var options;
				
				
				// disable until status update submitted
				self.prop("disabled", true);
				
				// Enable button to send update request
				create.prop("disabled", false);
				
				// Update module
				disableStatusBlock(div);
				
				options = extractStatusData(div);
				options.transtype = "UPDATEFORMSTATUS";
				options.formId = ul[0].form.formId;
				
				// Send update request
				Util.send(options, function (response) {
					// Update content 
					ul[0].form = response;
					setFormData(response);

					$("#updateError").text("");
				}, function (error) {
				    $(ul.children().toArray()[0]).remove();
					$("#updateError").text(error.responseText);
				});
			}
			
			var onOpenOtherModal = function () {
				$("#otherModal").modal({"show": true});
			}
			
			var onOpenGradeModal = function () {
				$("#gradeModal").modal({"show": true});
			}
			
			
			var onSearchFormClick = function () {
				var options;
				
				options = {
						"transtype": "GETFORM",
						"formId": $("#frmSearchInput").val()
				};
				
				// clear all fields 
				clearForm();

				// Attempt to find 
				Util.send(options, function (response) {
					//cache response
					$("#frmStatusList")[0].form = response;
					$("#frmStatusList").empty();
					
					if (response) {
						setFormData(response);
						
						// Load status
						options = {
								"transtype": "GETFORMSTATUS",
								"formId": response.formId
						};
						
						Util.send(options, function (response){
							buildStatusList(response);
						});
					}
				});
			}
			
			var onDownloadFile = function () {
				$("#frmTranstypeDownload").prop("disabled", false);
				$("#frmFileId").prop("disabled", false);
				$("#frmFileDownloadSubmit").prop("disabled", false);
				

				$("#frmTranstypeDownload").val("DOWNLOADFORMFILE");
				$("#frmFileId").val($(this).attr("id"));
				$("#frmFileDownloadSubmit").click();
			}
			
			
			///
			//	EXECUTE
			///
			
			execute = function(type) {
				if (type === "screen") {
					initHTML();
					initEventHandlers();
				}
			}
		</script>
		
	<div is-drawer>
		<div class="row">
			<div class="col-xs-12">
				<label>Form: <span info-icon="Pull existing form from server"></span></label>
				<input id="frmSearchInput" class="form-control" type="number">
			</div>
		</div>
		<div style="padding-bottom: 5px;"></div>
		<div class="row">
			<div class="col-xs-12">
				<button id="frmSearchForm" class="btn-primary form-control"><span class="fa fa-search"></span> Search</button>
			</div>
		</div>

		<!-- SPLIT  -->
		<div style="height: 5px; padding-top: 5px; padding-bottom: 5px;">
			<hr class="hr-divider" style="margin: 0px;">
		</div>
		
		<div class="row">
			<div class="col-xs-12">
				<button id="frmCreateFormStatusUpdate" class="form-control btn-secondary"><span class="fa fa-plus"></span> Create</button>
			</div>
		</div>
		<div style="height: 5px; padding-top: 5px; padding-bottom: 5px;"></div>
		<div class="row">
			<div class="col-xs-12">
				<button id="frmSubmitStatusUpdate" class="form-control" disabled><span class="fa fa-send"></span> Update Status</button>
			</div>
		</div>
	</div>
	

	<div is-screen>
		<style>
		
			.file-list {
				list-style: none;
			}
		
			ul[class~='file-list'] > li:hover{
				border: 1px solid blue;
			}
		
		
			.user-info-block {
				min-height: 790px;
			}
		
			.form-max-width {
				max-width: 600px;
			}
			
			.form-max-width > form {
				height: 100%;
			}
			
			.form-description {
				height: 150px;
				resize: none;
			}
			
			.form-status-list {
				list-style: none;
				padding-left: 5px;
				margin-left: 0px;
			}
			
		</style>

		<!-- FORM -->
		<div class="user-info-block">
			<div class="form-max-width center-block">
				<div class="text-center">
					<label style="font-size: 2.0em">Form <span id="formIdHeader"></span></label>
				</div>
				<ul id="frmPills" class="nav nav-pills">
				  <li class="active" page="frmPageForm">
				  	<a>Application</a>
				  </li>
				  <li page="frmPageStatus">
				  	<a>Status</a>
				  </li>
				</ul>
				<div id="frmPageForm">
					<label>Employee Information:</label>
					<hr class="hr-divider">
					<div class="row">
						<div class="col-sm-4">
							<label>ID: <span info-icon="What is used to idenitify your account"></span></label>
							<input id="frmUserId" class="form-control" disabled>
						</div>
						<div class="col-sm-4">
							<label>First Name:</label>
							<input id="frmFirstName" class="form-control" disabled>
						</div>
						<div class="col-sm-4">
							<label>Last Name:</label>
							<input id="frmLastName" class="form-control" disabled>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4">
							<label>Email:</label>
							<input id="frmEmail" type="email" class="form-control" disabled>
						</div>
						<div class="col-sm-4">
							<label>Phone number:</label>
							<input id="frmPhoneNumber" class="form-control" disabled>
						</div>
						<div class="col-sm-4">
							<label>Department:</label>
							<input id="frmApplicationDepartment" class="form-control" disabled>
						</div>
					</div>
					
					<div style="padding-bottom: 5px;"></div>
					<label>Reimbursement Information: <span info-icon="All fields are **REQUIRED**"></span></label>
					<hr class="hr-divider">
					
					<div class="row">
						<div class="col-sm-6">
							<label>Status:</label>
							<select id="frmApplicationStatus" class="form-control" disabled></select>
						</div>
						<div class="col-sm-6">
							<label>Type:</label>
							<select id="frmReimbursementType" class="form-control" disabled></select>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4">
							<label>Address:</label>
							<input id="frmApplicationAddress" class="form-control" disabled></select>
						</div>
						<div class="col-sm-4">
							<label>State:</label>
							<select id="frmApplicationState" class="form-control" disabled></select>
						</div>
						<div class="col-sm-4">
							<label>City:</label>
							<select id="frmApplicationCity" class="form-control" disabled></select>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<label>Event Start Date: <span info-icon="When does the event begin?"></span></label>
							 <div class="form-group">
				                <div class='input-group date' id='frmEventStartDTP'>
				                    <input id="frmEventStartDTPInput" type='text' class="form-control" disabled />
				                    <span class="input-group-addon">
				                        <span class="glyphicon glyphicon-calendar" disabled></span>
				                    </span>
				                </div>
				            </div>
						</div>
						<div class="col-sm-6">
							<label>To: <span info-icon="When does the event end?"></span></label>
							 <div class="form-group">
				                <div class='input-group date' id='frmEventEndDTP'>
				                    <input id="frmEventEndDTPInput" type='text' class="form-control" disabled />
				                    <span class="input-group-addon" disabled>
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<label>Time-off Start: <span info-icon="Start day, when you will not be able to come to work?"></span></label>
							 <div class="form-group">
				                <div class='input-group date' id='frmWorkOffStartDTP'>
				                    <input id="frmWorkOffStartDTPInput" type='text' class="form-control" disabled />
				                    <span class="input-group-addon" disabled>
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
						<div class="col-sm-6">
							<label>Time-off end: <span info-icon="Last day off from work (You will go to work during the next work-day)"></span></label>
							 <div class="form-group">
				                <div class='input-group date' id='frmWorkOffEndDTP'>
				                    <input id="frmWorkOffEndDTPInput" type='text' class="form-control" disabled />
				                    <span class="input-group-addon" disabled>
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<label>Grading: <span info-icon="Grading template used by organization"></span></label>
							<select id="frmGradeScale" class="form-control" disabled></select>
						</div>
						<div class="col-sm-6">
							<label style="padding-bottom: 5px;"><p></p></label>
							<button id="frmGradeAttachments" class="form-control btn-secondary"><span class="fa fa-link"></span> Grade Attachments</button>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<label>Cost: <span info-icon="Total cost for event"></span></label>
							<input id="frmApplicationCost" class="form-control" disabled>
						</div>
						<div class="col-sm-6">
							<label>Estimate: <span info-icon="Estimated reimbursement value based on form data and remaining balance"></span></label>
							<input id="frmApplicationEstimate" class="form-control" disabled>
						</div>
					</div>
					
					<div class="row">
						<div class="col-sm-12">
							<label>Description: <span info-icon="Work related description why you should be reimburset for specified amount"></span></label>
							<textarea id="frmDescription" class="form-control form-description" disabled></textarea>
						</div>
					</div>
					
					<div style="padding-bottom: 5px;"></div>
					<hr class="hr-divider">
					<div style="padding-bottom: 5px;"></div>
					
					<div class="row">
						<div class="col-sm-12">
							<button id="frmOtherAttachments" class="form-control btn-secondary"><span class="fa fa-link"></span> Other Attachments</button>
						</div>
					</div>
				</div>
			
				<div id="frmPageStatus" hidden>
					<label>Application Status - Most recent change is placed on-top <i id="updateError" style="color:red;"></i></label>
					<hr class="hr-divider">
					<ul id="frmStatusList" class="form-status-list"> 
						<!-- STATUS UPDATES FOR FORMS GO HERE  -->
					</ul>
				</div>
			</div>
			
			<!-- TEMPLATE USED TO REPRESENT STATUS UPDATES -->
			<div update-form-module-template hidden>
				<div class="new-status">
					<div class="row">
						<div class="col-sm-4">
							<label>Processed By: <span info-icon="Who processed/updated application status"></span></label>
							<input id="frmProcessedBy" class="form-control" disabled>
						</div>
						<div class="col-sm-4">
							<label>Status: <span info-icon="Application status"></span></label>
							<select id="frmStatus" class="form-control"></select>
						</div>
						<div class="col-sm-4">
							<label>Timestamp: <span info-icon="Time when application was updated"></span></label>
							<input id="frmStatusTimeStamp" class="form-control" disabled>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<label>Original Estimate: <span info-icon="What was originally calculated on form"></span></label>
							<input id="frmOriginalEstimate" class="form-control" disabled>
						</div>
						<div class="col-sm-6">
							<label>Actual Price: <span info-icon="Price adjusted by admin"></span></label>
							<input id="frmActualPrice" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<label>Description: <span info-icon="Reasoning behind admin. decision"></span></label>
							<textarea id="frmStatusDescription" class="form-control form-description"></textarea>
						</div>
					</div>
					<div style="padding-top:5px;"></div>
					<hr class="hr-divider">
				</div>
			</div>
			
			<!-- HIDDEN SELECTS USED TO CACHE IMPORTANT DATA -->
			<div hidden>
				<select id="frmStatusData"></select>
			</div>
			
			<!-- Modal -->
			<div class="modal fade" id="gradeModal" tabindex="-1" role="dialog" aria-labelledby="gradeModalLabel" aria-hidden="true">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="gradeModalLabel">Grading Scale Attachment Uploads</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body">
				        <ul id="frmGradeFileList" class="file-list"></ul>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			      </div>
			    </div>
			  </div>
			</div>
			
			<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="otherModalLabel" aria-hidden="true">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="otherModalLabel">Other Attachment Uploads</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body">
				        <ul id="frmOtherFileList" class="file-list"></ul>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			      </div>
			    </div>
			  </div>
			</div>
			
			<form  method="post" action="Dashboard">
				<div hidden>
					<input name="transtype" value="DOWNLOADFORMFILE" id="frmTranstypeDownload"/>
					<input name="fileId" id="frmFileId" />
					<input name="submit" type="submit" value="submit" id="frmFileDownloadSubmit" />
				</div>
			</form> 
		</div>
	</div>
	
</body>