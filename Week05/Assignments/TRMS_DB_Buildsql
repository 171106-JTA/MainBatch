DROP SEQUENCE Empl_Id_Seq;
DROP SEQUENCE Cont_Index_Incr_Seq;
DROP SEQUENCE Contact_Info_Index_Seq;
DROP SEQUENCE TRR_Tracking_Number_Seq;

DROP TRIGGER Empl_Default_Trg; 
DROP TRIGGER Contact_Info_Default_Trg;
/
DROP TABLE TuitionReimbursmentRequest CASCADE CONSTRAINTS; 
DROP TABLE EventTypes CASCADE CONSTRAINTS;
DROP TABLE Grades CASCADE CONSTRAINTS;
DROP TABLE GradingFormats CASCADE CONSTRAINTS;
DROP TABLE ReimbursementStatus CASCADE CONSTRAINTS;
DROP TABLE Positions CASCADE CONSTRAINTS;
DROP TABLE Department CASCADE CONSTRAINTS;
DROP TABLE Employee CASCADE CONSTRAINTS;
DROP TABLE ContactInformation CASCADE CONSTRAINTS; 

    
 /   
create table ContactInformation (
    contact_index number(3) NOT NULL,
    firstname varchar2(30),
    lastname varchar2(30), 
    phoneNumber varchar2(15),
    email varchar2(80),
    streetAddress varchar2(80),
    city varchar2(40),
    state varchar2(20),
    zipcode varchar2(10),
    CONSTRAINT PK_index PRIMARY KEY (contact_index)
);
/
create table Employee(
    employeeID number(3) NOT NULL,
    firstname varchar2(30) NOT NULL,
    lastname varchar2(30) NOT NULL,
    loginUserId varchar2(32) NOT NULL unique,
    loginPassword varchar2(32) NOT NULL,
    contactInformationKey number(3) NOT NULL,
    emergencyContactKey number(3),
    deptID number(3),
    supervisorEmpID number(3), 
    positionID number(3),
    CONSTRAINT PK_EmpID PRIMARY KEY (employeeID), 
    CONSTRAINT FK_EMP_Contact_Info FOREIGN KEY (contactInformationKey) REFERENCES ContactInformation(contact_index),
    CONSTRAINT FK_EMP_Emerg_Contact FOREIGN KEY (emergencyContactKey) REFERENCES ContactInformation(contact_index)
);

/
create table Department (
    deptID number(3),
    name varchar2(80)  NOT NULL,
    departmentHeadID number(3),
    CONSTRAINT PK_deptID PRIMARY KEY (deptID),
    CONSTRAINT FK_DEP_deptHead FOREIGN KEY (departmentHeadID) REFERENCES Employee(employeeID)
);
/
create table Positions (
    positionID number(3),
    title varchar2(50),
    deptID number(3),
    CONSTRAINT PK_positionID PRIMARY KEY (positionID),
    CONSTRAINT FK_POS_department FOREIGN KEY (deptID) REFERENCES Department(deptID)
);
/
create table ReimbursementStatus (
    employeeID number(3) NOT NULL, 
    availableReimbursement number(8,2) NOT NULL,
    pendingReimbursement number(8,2),
    CONSTRAINT FK_RS_empID FOREIGN KEY (employeeID) REFERENCES Employee(employeeID)
);
/
create table GradingFormats (
    code varchar2(15),
    description varchar2(30) unique,
    CONSTRAINT PK_code PRIMARY KEY (code)
);
/
create table Grades ( 
    gradingFormat varchar2(30),
    grade varchar2(20) unique,
    passes varchar2(1), 
    CONSTRAINT FK_Grade_Grading_Format_Code FOREIGN KEY (gradingFormat) REFERENCES GradingFormats(code)
);
/
create table EventTypes (
    eventType varchar2(80),
    reimbursementCoverage number(4,2),
    gradingFormat varchar2(15),
    CONSTRAINT PK_eventType PRIMARY KEY (eventType),
    CONSTRAINT FK_Event_Grading_Format_Code FOREIGN KEY (gradingFormat) REFERENCES GradingFormats(code)
); 
/
create table TuitionReimbursmentRequest (
    trackingNumber number(5), 
    requesterLoginId varchar2(30),
    eventName varchar2(60),
    eventDate timestamp,
    eventAddress varchar2(140),
    eventType varchar2(80),
    eventDescription varchar2(140),
    unmodifiedCost number(6,2),
    gradingFormat varchar2(15),
    justification varchar2(140),
    workHoursMissing varchar2(15),
    supervisorApproved number,
    deptHeadApproved number,
    benCoApproved number,
    created_On TIMESTAMP,
    CONSTRAINT PK_trackingNumber PRIMARY KEY (trackingNumber),
    CONSTRAINT FK_TRR_EmpID FOREIGN KEY (requesterLoginId) REFERENCES Employee(loginUserId),
    CONSTRAINT FK_TRR_eventType FOREIGN KEY (eventType) REFERENCES EventTypes(eventType),
    CONSTRAINT FK_TRR_gradingFormat FOREIGN KEY (gradingFormat) REFERENCES GradingFormats(code)
);
/
CREATE SEQUENCE Empl_Id_Seq start with 1 increment by 1;
CREATE SEQUENCE Cont_Index_Incr_Seq start with 1 increment by 1; 
CREATE SEQUENCE TRR_Tracking_Number_Seq start with 1 increment by 1; 
CREATE SEQUENCE Contact_Info_Index_Seq start with 1 increment by 1; 
/
--Increment ID and default information on employee
CREATE OR REPLACE TRIGGER Empl_Default_Trg
BEFORE INSERT ON Employee
FOR EACH ROW
DECLARE 
    newEmpId number;
    newIndex number; 
BEGIN
    newEmpId := 0; 
    if :new.employeeid is null then
        newEmpId := Empl_Id_Seq.nextval; 
        :new.employeeId := newEmpId; 
    end if; 
    if :new.contactInformationKey is null then 
        newIndex := Contact_Info_Index_Seq.nextval; 
        :new.contactInformationKey :=newIndex;
        INSERT INTO ContactInformation(firstname, lastname, contact_index) 
            values(:new.firstname, :new.lastname, newIndex); 
    end if; 
    if :new.emergencyContactKey is null then 
        newIndex := Contact_Info_Index_Seq.nextval; 
        :new.emergencyContactKey :=newIndex;
        INSERT INTO ContactInformation(contact_index) values(newIndex); 
    end if; 
    if newEmpId = 0 then
        newEmpId := Empl_Id_Seq.nextval;
    end if; 
    
    --INSERT INTO ReimbursementStatus values(newEmpid, 1000.00, 0.00); 
    
END; 
/

--Increment Index and set default info for contact information. 
CREATE OR REPLACE TRIGGER Contact_Info_Default_Trg
BEFORE INSERT ON ContactInformation
FOR EACH ROW
BEGIN
    if :new.firstname is null then
        select 'N/A' into :new.firstname from dual;
    end if; 
    if :new.lastname is null then
        select 'N/A' into :new.lastname from dual; 
    end if; 
    if :new.phoneNumber is null then
        select 'N/A' into :new.phoneNumber from dual; 
    end if; 
    if :new.email is null then
        select 'N/A' into :new.email from dual; 
    end if; 
    if :new.streetAddress is null then
        select 'N/A' into :new.streetAddress from dual; 
    end if; 
    if :new.city is null then
        select 'N/A' into :new.city from dual; 
    end if; 
    if :new.state is null then
        select 'N/A' into :new.state from dual; 
    end if; 
    if :new.zipcode is null then
        select 'N/A' into :new.zipcode from dual; 
    end if; 
END; 
/

CREATE OR REPLACE TRIGGER TR_Request_Default_Trg
BEFORE INSERT ON TuitionReimbursmentRequest
FOR EACH ROW
BEGIN
    if :new.trackingNumber is null then 
        :new.trackingNumber := TRR_Tracking_Number_Seq.nextval;
    end if; if :new.eventName is null then
        :new.eventName := 'N/A'; 
    end if; 
    if :new.eventDate is null then
        :new.eventDate := TO_DATE('01011970 12:00', 'MMDDYYYY HH:MI:SS');
    end if;
    if :new.eventAddress is null then
        :new.eventAddress := 'N/A'; 
    end if;
    if :new.eventType is null then
        :new.eventType := 'N/A';
    end if;
    if :new.eventDescription is null then
        :new.eventDescription := 'N/A';
    end if;
   
    if :new.unmodifiedCost is null then
        :new.unmodifiedCost := 0;
    end if;    
    
    if :new.gradingFormat is null then
         select EventTypes.gradingFormat into :new.gradingFormat 
            from EventTypes where EventTypes.eventType = :new.eventType;
    end if; 
    if :new.justification is null then
        :new.justification := 'N/A';
    end if;
   
    if :new.workHoursMissing is null then
        :new.workHoursMissing := 'N/A';
    end if;
    if :new.supervisorApproved is null then 
        :new.supervisorApproved := 0; 
    end if; 
    if :new.deptHeadApproved is null then 
        :new.deptHeadApproved := 0; 
    end if; 
    if :new.benCoApproved is null then 
        :new.benCoApproved := 0; 
    end if;     
    if :new.created_on is null then 
        :new.created_on := CURRENT_TIMESTAMP;
    end if; 
END;
/


CREATE OR REPLACE TRIGGER On_Position_Create 
BEFORE INSERT ON Positions
FOR EACH ROW
DECLARE
    newPosId number;
    newDepId number; 
BEGIN
    if :new.positionId is null and :new.deptId is not null then
        select max(positionId) into newPosId from Positions 
            where deptId = :new.deptId order by Positions.positionID desc;
        if newPosId is null then
            newPosId := :new.deptId*100;
        end if;
        :new.positionId := newPosId + 1;
    end if;
END;
/

CREATE OR REPLACE TRIGGER On_Employee_Delete 
BEFORE DELETE ON Employee
FOR EACH ROW
DECLARE 
    
BEGIN
    DELETE FROM ContactInformation where contact_index = :old.contactInformationKey;
    DELETE FROM ContactInformation where contact_index = :old.emergencyContactKey;
END;
/
CREATE OR REPLACE PROCEDURE Assign_Department_Head( loginId IN varchar2, 
    department_name IN varchar2)
IS
    eId number;
    dId number; 
BEGIN
    select employeeId into eId from employee 
        where loginUserId = loginId; 
    select deptId into dId from department
        where name = department_name; 
        
    update Employee set deptId = dId
        where loginUserId = loginId;
    
    update Department set departmentHeadID = eId
        where name = department_name; 
END;
/

--CREATE OR REPLACE PROCEDURE 



CREATE OR REPLACE PROCEDURE Create_Employee_Full (
    firstname IN varchar2, lastname IN varchar2, username IN varchar2, password IN varchar2,
    department IN varchar2, position IN varchar2, supervisor IN varchar2, 
    email IN varchar2, phone IN varchar2,
    streetAddr IN varchar2, city IN varchar2, state IN varchar2, zipcode IN varchar2)
IS
BEGIN
    commit; 
    SET TRANSACTION NAME 'inserting_new_employee';  
    
    insert into Employee(firstname, lastname, loginUserId, loginPassword,
        deptId, positionId, supervisorEmpId) 
        values(
        Create_Employee_Full.firstname, 
        Create_Employee_Full.lastname,
        Create_Employee_Full.username,
        Create_Employee_Full.password,
        (select Department.deptId from Department where Department.name = Create_Employee_Full.department),
        (select positionId from Positions where Positions.title = Create_Employee_Full.position),
        (select EmployeeId from Employee where Employee.loginUserId = supervisor));

    SAVEPOINT after_insert; 
        
    --update contact info on new employee
    UPDATE ContactInformation set
        ContactInformation.phoneNumber = Create_Employee_Full.phone,
        ContactInformation.email = Create_Employee_Full.email,
        ContactInformation.streetAddress = Create_Employee_Full.streetAddr,
        ContactInformation.city = Create_Employee_Full.city,
        ContactInformation.state = Create_Employee_Full.state,
        ContactInformation.zipcode = Create_Employee_Full.zipcode
        where contact_index = 
            (select contactInformationKey from Employee where loginUserId = username);
    
    SAVEPOINT after_update_contact_info;
    
    commit; 
END;
/

CREATE OR REPLACE PROCEDURE Create_Position(positionName IN varchar2, deptId IN number)
IS
BEGIN
    INSERT INTO Positions(title, deptId) VALUES(
        Create_Position.positionName, Create_Position.deptId);
END;
/

CREATE OR REPLACE PROCEDURE Create_New_TR_Request(
    requesterUsername IN varchar2, eventName varchar2,
    date_String IN varchar2, time_String IN varchar2, address IN varchar2,
    eventType IN varchar2, description IN varchar2, cost IN varchar2, 
    justification IN varchar2, workHoursMissing IN varchar2)
IS
    evt_Date DATE; 
    gradeFormat varchar2(15);
BEGIN
    commit;
    SET TRANSACTION NAME 'Create_TR_Request';
    
    evt_Date := TO_TIMESTAMP((date_String || ' ' || time_String), 'MM/DD/YYYY HH:MI:SSXFF');
    select EventTypes.gradingFormat into gradeFormat from EventTypes where EventTypes.eventType = 
        Create_New_TR_Request.eventType; 
        
    SAVEPOINT after_set_vars;
    
    INSERT INTO TuitionReimbursmentRequest Values(
        null,
        requesterUsername,
        Create_New_TR_Request.eventName,
        evt_Date,
        Create_New_TR_Request.address,
        Create_New_TR_Request.eventType,
        Create_New_TR_Request.description,
        Create_New_TR_Request.cost,
        gradeFormat,
        Create_New_TR_Request.justification,
        Create_New_TR_Request.workHoursMissing,
        0, 0, 0,
        CURRENT_TIMESTAMP);
    commit; 
END;
/


--CREATE OR REPLACE PROCEDURE Record_Emergency_Contact(username IN varchar2, 
    





